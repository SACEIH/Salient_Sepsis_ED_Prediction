WITH FILTER_DIAGNOSES AS (SELECT concat('%',concat(DIAGNOSISCODE,'%' )) Diagnosis_LIst FROM DEV_DAP_CAE05_DB.SEPSIS.VW_CONFIG_DIAGNOSISCODE)
SELECT * FROM (
SELECT DISTINCT
	ROW_NUMBER() OVER (PARTITION BY j.JOURNEY_ID ORDER BY j.ADMITDTM) IP_SEQ_BY_JOURNEY,
	CASE  WHEN j.DIAGNOSISCODE IN (SELECT DIAGNOSISCODE FROM DEV_DAP_CAE05_DB.SEPSIS.VW_CONFIG_DIAGNOSISCODE ) THEN 1 ELSE 0 END AS Primary_Sepsis,
	CASE WHEN j.ALLCHARDIAGNOSIS LIKE ANY (SELECT Diagnosis_LIst FROM FILTER_DIAGNOSES) THEN 1 ELSE 0 END AS Any_Sepsis,
	j.*
--		FIRST_VALUE(J.ADMITDTM) OVER (PARTITION BY J.JOURNEY_ID ORDER BY J.ADMITDTM ASC  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS JAdmitDtm,
--		LAST_VALUE(J.dischargedtm) OVER (PARTITION BY J.JOURNEY_ID ORDER BY J.DISCHARGEDTM ASC  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS JDischargeDtm
		FROM DEV_DAP_CAE05_DB.JNY.VW_PATIENT_JOURNEY_MAPPING_NEW AS J
					WHERE J.JOURNEY_ID IN (
		SELECT v.JOURNEY_ID 
		FROM DEV_DAP_CAE05_DB.SEPSIS.VW_ED_VISIT  AS V 	
		WHERE j.ADMITDTM > V.ADMITDTM AND v.ADMITDTM < '2023-02-01'
		)
		and j.TYPECODE != 'Emergency'
		ORDER BY J.JOURNEY_ID)
		WHERE IP_SEQ_BY_JOURNEY=1 -- AND PRIMARY_SEPSIS =1
		
		
WITH FILTER_DIAGNOSES AS (SELECT concat(concat('(\'%',listagg(DIAGNOSISCODE,'%\',\'%' )),'%\')') AS Diagnosis_LIst FROM DEV_DAP_CAE05_DB.SEPSIS.VW_CONFIG_DIAGNOSISCODE )
SELECT *,
 CASE WHEN 'A4151 R572 D70 N179 A099 D696 J690 R13 C329 C787 C795 E440 U0712 Z8643 Z515' LIKE ANY (SELECT Diagnosis_LIst FROM FILTER_DIAGNOSES) THEN 1 ELSE 0 END AS Any_Sepsis
FROM FILTER_DIAGNOSES

SELECT CASE WHEN 'A4151 R572 D70 N179 A099 D696 J690 R13 C329 C787 C795 E440 U0712 Z8643 Z515' LIKE ANY 
('%A021%','%A227%','%A267%','%A327%','%A40%','%A400%','%A401%','%A402%','%A403%','%A408%','%A409%','%A41%','%A410%','%A411%','%A412%','%A413%','%A414%','%A415%','%A4150%','%A4151%','%A4152%','%A4158%','%A418%','%A419%','%A427%','%B377%','%O85%','%P36%','%P360%','%P361%','%P362%','%P363%','%P364%','%P365%','%P368%','%P369%','%R651%')
THEN 1 ELSE 0 end


FROM FILTER_DIAGNOSES


WITH FILTER_DIAGNOSES AS (SELECT concat('%',concat(DIAGNOSISCODE,'%' )) Diagnosis_LIst FROM DEV_DAP_CAE05_DB.SEPSIS.VW_CONFIG_DIAGNOSISCODE)
--SELECT * FROM FILTER_DIAGNOSES
SELECT CASE WHEN 'A4151 R572 D70 N179 A099 D696 J690 R13 C329 C787 C795 E440 U0712 Z8643 Z515' LIKE ANY (SELECT * FROM FILTER_DIAGNOSES)  THEN 1 ELSE 0 END AS Any_Sepsis