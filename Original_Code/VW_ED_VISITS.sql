WITH FILTER_DT AS (
SELECT 
'01-JAN-2023' START_DT,
to_date(getdate()) END_DT
),
VISIT AS (
    SELECT 
        VISIT.* 
        ,CASE WHEN CL.DECEASEDDATE > '1/1/1900' THEN 1 ELSE 0 END  DECEASEDFLAG
        ,CL.DECEASEDDATE
        ,CL.DECEASEDTIME
        ,CASE WHEN CL.DECEASEDDATE BETWEEN VISIT.ADMITDATE AND IFNULL(VISIT.DISCHARGEDATE,GETDATE()) THEN 1 ELSE 0 END DECEASEDDURINGSTAY
        , CL.HOMELESS_FLAG ED_HOMELESS_FLAG
    FROM DEV_DAP_CAE05_DB.JNY.VW_VISIT_ED AS VISIT
    -- PRD_DAP_EMR_DB.DBO.CV3CLIENTVISIT AS VISIT 
    INNER JOIN FILTER_DT DT
        ON ( (VISIT.ADMITDATE   BETWEEN DATEADD(month,-1,DT.START_DT) and DT.END_DT) ) -- one month negated to obtain readmits upto 30 days
        AND UPPER(VISIT.VISITTYPE ) IN ( 'EMERGENCY') --,'INPATIENT' -- TYPECODE
        AND RTRIM(UPPER(VISIT.VISITSTATUS)) IN ('DSC') 
    INNER JOIN DEV_DAP_CAE05_DB.JNY.VW_CLIENT_DETAILS CL
        ON CL.CLIENTGUID = VISIT.CLIENTGUID        
)
,ED_VISIT AS (
SELECT
	LAG(VISIT.VISITGUID) OVER (partition by VISIT.clientGUID order by VISIT.ADMITDATE ASC) PRE_visitguid
    ,VISIT.*   
	,PATIENT.COUNTRYOFBIRTH
	,PATIENT.CITYOFBIRTH
	,PATIENT.ACTIVE PATIENT_ACTIVE
	,PATIENT.GENDERCODE GENDERCODE
	--,PATIENT.DISPLAYNAME
	--,PATIENT.FIRSTNAME
	, CASE RTRIM(UPPER(PATIENT.GENDERCODE)) 
	WHEN 'MALE' THEN 0
	WHEN 'FEMALE' THEN 1
	ELSE -1
	END AS GENDER
	,PATIENT.BIRTHYEARNUM
	,PATIENT.BIRTHMONTHNUM
	, PATIENT.BIRTHDAYNUM
	--,CAST(DATEFROMPARTS(BIRTHYEARNUM,BIRTHMONTHNUM, BIRTHDAYNUM)  AS DATE) DOB
    ,DATEDIFF(YEAR,DOB,CAST(DATEFROMPARTS(BIRTHYEARNUM,BIRTHMONTHNUM, BIRTHDAYNUM)  AS DATE))  AS AGEONADMISSION
	--,0 AGEONADMISSION
	--,DATEDIFF(YEAR,DATEFROMPARTS(PATIENT.BIRTHYEARNUM,PATIENT.BIRTHMONTHNUM, PATIENT.BIRTHDAYNUM),VISIT.ADMITDTM) AGEONADMISSION
	, CASE RTRIM(UPPER(PATIENT.RACECODE))
	WHEN 'NOT ABORIGINAL-TSI' THEN 0
	WHEN 'NOT STATED' THEN 0
	ELSE 1
	END AS ETHNICITY --NEEDS REVIEW
	, CASE RTRIM(UPPER(PATIENT.LANGUAGECODE))
	WHEN 'ENGLISH' THEN 0
	WHEN 'UNKNOWN' THEN 2
	ELSE 1
	END AS PRIMARYLANGUAGE
	, CASE RTRIM(UPPER(PATIENT.MARITALSTATUSCODE))
	WHEN 'UNK-NOT STATED' THEN 4
	WHEN 'MARRIED-DEFACTO' THEN 1
	WHEN 'SEPARATED' THEN 2
	WHEN 'DIVORCED' THEN 2
	WHEN 'NEVER MARRIED' THEN 0 --SINGLE
	WHEN 'WIDOWED' THEN 3
	ELSE 4
	END AS MARITALSTATUS
	,DATEDIFF(HH,TO_TIMESTAMP( VISIT.ADMITDATE ),TO_TIMESTAMP( VISIT.DISCHARGEDATE )) TIMEDIFFERANCE_ADMISSION_DISCHARGE_HRS
	,DATEDIFF(MI,TO_TIMESTAMP( VISIT.ADMITDATE ),TO_TIMESTAMP( VISIT.DISCHARGEDATE )) TIMEDIFFERANCE_ADMISSION_DISCHARGE_MIN
	,IFF(DATEDIFF(MINUTE,VISIT.ADMITDATE,VISIT.DISCHARGEDATE)<=360,'YES','NO') AS DISCHARGEDIN_360MIN_OR_6HOURS
	,IFF(RIGHT(RTRIM(UPPER(VISIT.DISCHARGEDISPOSITION)),4)='EECU', 'YES','NO') AS EECU
	--,VISIT.DISCHARGEDISPOSITION
    ,'HOMELESS' SCN_HEADER
    ,VISIT.ED_HOMELESS_FLAG SCN_CODE_FLAG
    ,HEALTHISSDECL.HISSUEDECL_CODE
    ,HEALTHISSDECL.HISSUEDECL_TYPECODE
    ,HEALTHISSDECL.HISSUEDECL_CODINGSCHEME
    ,HEALTHISSDECL.HISSUEDECL_DESCRIPTION              
	,SUPPED.TRIAGECATEGORY TRIAGECATEGORY
	,SUPPED.MODEOFARRIVAL MODEOFARRIVAL
	,SUPPED.WORKINJURYORMVA
	,SUPPED.FUNDINGSOURCE
	,SUPPED.DB4PRINTED
	,SUPPED.CONSENTCOMMENT
	,SUPPED.CONSENTTONOTIFYGP
	,SUPPED.SAASEVENTNUMBER
	,SUPPED.SAASDISPATCHNUMBER
	--,SUPPED.UPDATEDATE
FROM VISIT AS VISIT 
   INNER JOIN FILTER_DT DT
        ON ( (VISIT.ADMITDATE   BETWEEN DT.START_DT and DT.END_DT) )
     INNER  JOIN PRD_DAP_EMR_DB.DBO.CV3CLIENT AS PATIENT 
        ON PATIENT.GUID = VISIT.CLIENTGUID
        AND UPPER(VISIT.VISITTYPE) = 'EMERGENCY'
        AND RTRIM(UPPER(VISIT.VISITSTATUS)) IN ('DSC') 
    INNER JOIN (
                SELECT 
            		ROW_NUMBER()OVER(PARTITION BY HEALTHISSDECL.CLIENTVISITGUID, HEALTHISSDECL.CLIENTGUID ORDER BY HEALTHISSDECL.CLIENTVISITGUID) SEQ
                    ,HEALTHISSDECL.CLIENTVISITGUID
                    ,HEALTHISSDECL.CLIENTGUID
            		,HEALTHISSDECL.CODE HISSUEDECL_CODE
            		,HEALTHISSDECL.TYPECODE HISSUEDECL_TYPECODE
            		,HEALTHISSDECL.CODINGSCHEME HISSUEDECL_CODINGSCHEME
            		,HEALTHISSDECL.DESCRIPTION HISSUEDECL_DESCRIPTION                
                FROM PRD_DAP_EMR_DB.DBO.CV3HEALTHISSUEDECLARATION AS HEALTHISSDECL
                INNER JOIN VISIT as VISIT 
                    ON HEALTHISSDECL.CLIENTVISITGUID = VISIT.VISITGUID  --ONLY ED DIAGNOSE, NOT SUBSEQUENT STAY
    			  AND HEALTHISSDECL.CLIENTGUID = VISIT.CLIENTGUID
                  AND UPPER(VISIT.VISITTYPE) = 'EMERGENCY' -- TYPECODE
               -- WHERE RTRIM(HEALTHISSDECL.CODE) IN (SELECT DIAGNOSISCODE FROM DEV_DAP_CAE05_DB.SCN_CRONICPAIN.VW_CONFIG_DIAGNOSISCODE)--( '279039007', '278860009', '278862001', 'M545', 'M54.5', 'M543','M54.3' )  --ICD10 CODE FOR LOWER BACK PAIN -- 'M543'
			     AND UPPER(HEALTHISSDECL.TYPECODE) IN ( 'ADMITTING DX', 'CHIEF COMPLAINT', 'ED DIAGNOSIS',-- 'PATIENT PROBLEM',  Q: IT CAN BE HISTORICAL DATA
													  'PRINCIPAL DX', 'SECONDARY DX', 'VISIT PROBLEM', 'VISIT REASON'
													)
                )HEALTHISSDECL
        		ON  HEALTHISSDECL.CLIENTVISITGUID = VISIT.VISITGUID  --ONLY ED DIAGNOSE, NOT SUBSEQUENT STAY
			  AND HEALTHISSDECL.CLIENTGUID = VISIT.CLIENTGUID
              AND IFNULL(HEALTHISSDECL.SEQ,0) = 1
              --AND VISIT.ED_HOMELESS_FLAG=1
        LEFT JOIN 	(
						SELECT  TO_VARCHAR(OBJGUID) AS VISITGUID
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS ED MODE OF ARRIVAL'				 THEN DAT.VALUE END) AS MODEOFARRIVAL
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS ED WORK INJURY OR MVA'		     THEN DAT.VALUE END) AS WORKINJURYORMVA
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS ED FUNDING SOURCE'			     THEN DAT.VALUE END) AS FUNDINGSOURCE
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS ED DB4 PRINTED'					 THEN DAT.VALUE END) AS DB4PRINTED
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS TRIAGE CATEGORY'					 THEN DAT.VALUE END) AS TRIAGECATEGORY
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS CONSENT COMMENT'					 THEN DAT.VALUE END) AS CONSENTCOMMENT
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS CONSENT TO NOTIFY GP OF VISIT'	 THEN DAT.VALUE END) AS CONSENTTONOTIFYGP
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS ED SAAS EVENT NUMBER'				 THEN DAT.VALUE END) AS SAASEVENTNUMBER
							,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'VS ED SAAS DISPATCH NUMBER'			 THEN DAT.VALUE END) AS SAASDISPATCHNUMBER
                            --,MAX(CASE WHEN UPPER(DAT.USERDATACODE) = 'PS USUAL ACCOMMODATION'			 THEN DAT.VALUE END) AS USUAL_ACCOMMODATION (this is by ClientGUID)
							,MAX(DAT.TOUCHEDWHEN) AS UPDATEDATE
							,GETDATE()        AS LOADDATE
						FROM PRD_DAP_EMR_DB.DBO.CV3CLIENTUSERDATA DAT 
						INNER JOIN VISIT VIS 
							ON DAT.OBJGUID = VIS.VISITGUID 
							AND UPPER(VIS.VISITTYPE) = 'EMERGENCY'  -- TYPECODE
						GROUP BY DAT.OBJGUID
                        )SUPPED 
			ON SUPPED.VISITGUID = VISIT.VISITGUID
),
PRE_VISIT AS
(SELECT 
    PRE_VISIT.VISITGUID as PRE_VISITGUID
	,PRE_VISIT.VISITTYPE AS PRE_VISITTYPE
    ,PRE_VISIT.LOCATION AS PRE_LOCATION
	,PRE_VISIT.DISCHARGEDISPOSITION AS PRE_DISCHARGEDISPOSITION
	,PRE_VISIT.ADMITDATE AS PRE_ADMITDATE
	,PRE_VISIT.DISCHARGEDATE AS PRE_DISCHARGEDATE
	,PRE_VISIT.DIAGNOSIS AS PRE_DIAGNOSIS    
FROM VISIT AS PRE_VISIT
    WHERE VISITGUID IN (SELECT PRE_VISITGUID FROM ED_VISIT)
)
SELECT 
PRE_VISIT.PRE_VISITTYPE as PRE_ED_VISITTYPE
	,PRE_VISIT.PRE_LOCATION AS PRE_ED_LOCATION
	,PRE_VISIT.PRE_DISCHARGEDISPOSITION AS PRE_ED_DISCHARGEDISPOSITION
	,PRE_VISIT.PRE_ADMITDATE AS PRE_ED_ADMITDATE
	,PRE_VISIT.PRE_DISCHARGEDATE AS PRE_ED_DISCHARGEDATE
	,PRE_VISIT.PRE_DIAGNOSIS AS PRE_ED_DIAGNOSIS
    ,DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) ED_READMIT_HOURS
    ,DATEDIFF(minute, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) ED_READMIT_MINUTES
    , CASE   
        WHEN (DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) <= 48) THEN 1
        ELSE 0
        END ED_READMIT_48HRS_FLAG
    , CASE   
        WHEN (DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) <= 24) THEN '0-24Hrs'
        WHEN (DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) BETWEEN 25 AND 48) THEN '25-48Hrs'
        WHEN (DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) BETWEEN 49 AND 168) THEN '3-7Days'
        WHEN (DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) BETWEEN 169 AND 720) THEN '8-30Days'
        WHEN (DATEDIFF(hour, PRE_VISIT.PRE_DISCHARGEDATE,ED_VISIT.ADMITDATE  ) > 720) THEN '>30Days'
    ELSE '' 
    END ED_READMIT_CLASSIFICATION
    ,ED_VISIT.*
FROM ED_VISIT
LEFT JOIN PRE_VISIT
on ED_VISIT.PRE_VISITGUID = PRE_VISIT.PRE_VISITGUID;